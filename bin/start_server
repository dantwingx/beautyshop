#!/bin/bash
set -e

echo "ğŸš€ Railway deployment starting..."

# í™˜ê²½ í™•ì¸
echo "ğŸ“ RAILS_ENV: ${RAILS_ENV:-not_set}"
echo "ğŸ“ PORT: ${PORT:-not_set}"
echo "ğŸ“ DATABASE_URL: ${DATABASE_URL:+set}"

# PORT ê¸°ë³¸ê°’ ì„¤ì •
export PORT=${PORT:-8080}
echo "ğŸ“ Using PORT: $PORT"

# ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
echo "ğŸ” Testing database connection..."
if bundle exec rails runner "ActiveRecord::Base.connection.execute('SELECT 1')" 2>/dev/null; then
  echo "âœ… Database connection successful"
else
  echo "âŒ Database connection failed"
  echo "ğŸ”§ Attempting database setup..."
  bundle exec rails db:create db:migrate db:seed || true
fi

# ì„œë²„ ì‹œì‘
echo "ğŸ”§ Starting Puma server on port $PORT..."
exec bundle exec puma -p $PORT -e ${RAILS_ENV:-production}