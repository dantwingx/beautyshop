#!/bin/bash
set -e

echo "ğŸš€ Railway Start Script"
echo "RAILS_ENV: ${RAILS_ENV:-not_set}"
echo "DATABASE_URL: ${DATABASE_URL:+[REDACTED]}"
echo "PORT: ${PORT:-not_set}"

# Set production environment
export RAILS_ENV=production
export PORT=${PORT:-3000}

# Run database migrations
echo "ğŸ“¦ Running database migrations..."
bundle exec rails db:migrate || echo "âš ï¸  Migration failed, continuing anyway"

# Seed database if needed (only on first deploy)
if [ ! -f /tmp/db_seeded ]; then
  echo "ğŸŒ± Seeding database..."
  bundle exec rails db:seed && touch /tmp/db_seeded || echo "âš ï¸  Seeding failed, continuing anyway"
fi

echo "ğŸ”§ Starting Rails server on port $PORT"

# Start the server
exec bundle exec rails server -b 0.0.0.0 -p $PORT